---
title: "PDA Project 3"
author: "Maia Lindner-Liaw"
date: "2024-12-03"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      warning = FALSE)
library(tidyverse)
library(lme4)
```

setting of r and g that minimize variance of the estimator

```{r}
sim_data<-function(alpha, beta, g, r, gamma, sigma, distribution){
  #'
  #' simulates data from a hierarchical data structure for normal or poisson distributions
  #' @param alpha the true intercept of the fixed term in the model
  #' @param beta the true treatment effect of the fixed term in the model
  #' @param g the number of clusters in the data, multiple of 2
  #' @param r the number of times to sample from each cluster
  #' @param gamma the standard deviation of the random intercept 
  #' @param sigma the standard deviation of the error term
  #' @distribution one of "normal" or "poisson", the distribution to sample from
  #' @return a list of the data and the estimated beta hat
  #'
  
  # generate treatment assignment for clusters, resample if all treated or all
  # control
  x<-rep(c(0,1), g/2)
  # sum=0
  # while(sum==0|sum==g){
  #   x<-rbinom(g, 1, .5)
  #   sum<-sum(x)
  # }
  # generate treatment assignment for observations (r from g groups)
  x_i<-rep(x, r)
  
  # save the cluster assignments for each observation
  j<-rep(1:g, r)

  # fixed effect mu_0 for each cluster
  mu_i0<-alpha+beta*x
  
  # random effect mu_i
  mu_i<-rnorm(g*r, mean=mu_i0, sd=gamma)
  
  if (distribution=="normal"){
    
    # generate normal outcomes
    y<-mu_i+rnorm(r*g, 0, sigma)
    
    # fit mixed effects model with random intercept
    fit<-lmer(y~1+x_i+(1|j))
    
    # extract beta estimate
    beta_hat<-summary(fit)$coefficients[2]
    
  }
  
  else {
    # log link, so exponentiate the normal 
    mu_i<-exp(mu_i)

    # generate poisson outcome
    y<-rpois(r*g, mu_i)
    
    # fit poisson mixed effects model with random intercept
    fit<-suppressWarnings(glmer(y~1+x_i+(1|j), family = poisson))
    
    # extract coefficient
    beta_hat<-summary(fit)$coefficients[2]
    
  }
  
  data=data.frame(y=y, x=x_i, cluster=j)
  
  return(list(data, beta_hat, num_clusters=g, num_samples=r))
}



s<-sim_data(1, 2, 4, 10, 1, 1, "poisson")
```



```{r}
gen_data<-function(alpha, beta, g, r, gamma, sigma, distribution, folder, filename){
  #' 
  #' Generate data and saves two files (one with data, one with coefficients and settings)
  #' @param alpha the true intercept of the fixed term in the model
  #' @param beta the true treatment effect of the fixed term in the model
  #' @param g the number of clusters in the data
  #' @param r the number of times to sample from each cluster
  #' @param gamma the standard deviation of the random intercept 
  #' @param sigma the standard deviation of the error term
  #' @distribution one of "normal" or "poisson", the distribution to sample from
  #' @param folder Path to folder in which to save files (include ending slash).
  #' @param filename File name prefix.
  #' @return saves 2 csv files with _data.csv and _coef_setting.csv suffixes.
  #' 
  
  #simulate data
  data<-sim_data(alpha, beta, g, r, gamma, sigma, distribution)
  
  # data file
  df<-data[[1]]
  write.csv(df, paste0(folder, filename,"_data.csv"), row.names=FALSE)
  
  # coef and settings file
  setting_df<-data.frame(alpha, beta, g, r, gamma, sigma, coef_est=data[[2]])
  write.csv(setting_df, paste0(folder,filename,"_coef_setting.csv"), row.names=FALSE)

}


```


```{r}
get_results_row<-function(iter, alpha, beta, g, r, gamma, sigma, distribution){
  #' 
  #' returns the data settings and the evaluation metrics
  #' @iter number of iterations
  #' @param alpha the true intercept of the fixed term in the model
  #' @param beta the true treatment effect of the fixed term in the model
  #' @param g the number of clusters in the data
  #' @param r the number of times to sample from each cluster
  #' @param gamma the standard deviation of the random intercept 
  #' @param sigma the standard deviation of the error term
  #' @distribution one of "normal" or "poisson", the distribution to sample from
  #' @return data frame row containing the settings used and the variance of the estimator
  #' 
  # initialize vector of beta alphas
  beta_hats<-c()

  
  # simulate iter times and extract values
  for (i in 1:iter){
    simulation<-sim_data(alpha, beta, g, r, gamma, sigma, distribution)
    beta_hats<-c(beta_hats, simulation[[2]])
  }
  
  # calculate variance of estimates
  variance<-var(beta_hats)
  
  return(data.frame(iterations=iter, alpha, beta, g, r, gamma, sigma, distribution, variance))
  
}


run_experiments<-function(iter, alpha, beta, g, r, gamma, sigma, distribution){
  #'
  #' runs the simulation for all given settings
  #' @iter number of iterations
  #' @param alpha the true intercept of the fixed term in the model
  #' @param beta the true treatment effect of the fixed term in the model
  #' @param g the number of clusters in the data
  #' @param r the number of times to sample from each cluster
  #' @param gamma the standard deviation of the random intercept 
  #' @param sigma the standard deviation of the error term
  #' @distribution one of "normal" or "poisson", the distribution to sample from
  #' @return data frame containing the settings and evaluation measures for each experiment
  
  results<-data.frame()
  # run simulations
  for (i in iter){
    for (a in alpha){
      for(b in beta){
        for(g1 in g){
          for(gam in gamma){
            for(s in sigma){
              row<-get_results_row(i, a, b, g1, r[which(g==g1)], gam, s, distribution)
              results<-rbind(results, row)
            }
          }

        }
      }
    }
  }
  

  return(results)
}
```


c2/c1

g*(c1+(r-1)*c2)<=B

given g, r equals
$$r\leq B/gc_2-c_1/c_2+1$$

when r=1, g is
$$g\leq B/c1$$
B=100k, c1=100, c2=95, c1/c2=1.05
```{r}
B=100000

c1=100
c2=95

calc_r<-function(g, B, c1, c2){
  #' calculates the maximum number of samples from each cluster to max out the budget
  #' @param g the number of clusters
  #' @param B the budget
  #' @param c1 the cost of the first sample from each cluster
  #' @param c2 the cost of each successive sample from each cluster
  #' @return the maximum number of samples to draw from each cluster
  #'
  r=floor(B/(g*c2)-c1/c2+1)
  
  return(r)
}

g=seq(2,50,2)
r=calc_r(g, B, c1, c2)
r<-r[which(r>1)]
g<-g[1:length(r)]


## r and g must be at least 2??
set.seed(1)
vary_gamma1<-run_experiments(100, 1, 2, g,r, c(.05, 1, 5, 10), 1, "normal")
vary_sigma1<-run_experiments(100, 1, 2, g,r, 1, c(.05, 1, 5, 10), "normal")
vary_alpha1<-run_experiments(100, c(-5, -1, 1, 5), 2, g,r, 1,1, "normal")
vary_beta1<-run_experiments(100, 1, c(-5, -1, 1, 5), g,r, 1,1, "normal")


gamma.plot1 <- ggplot(data = vary_gamma1, aes(x = g, y=variance)) +
  geom_line()+
  labs(
    title = "Variance as Cluster Number Increases, Varying Gamma",
    x = "Number of Clusters (g)",
    y = "Variance") +
  theme_minimal() +
  theme(legend.position = "bottom")+
  facet_wrap(~factor(gamma, levels = c(0.05,1, 5, 10), labels = 
                       c("gamma=0.05", "gamma=1", "gamma=5", "gamma=10")))
gamma.plot1


sigma.plot1 <- ggplot(data = vary_sigma1, aes(x = g, y=variance)) +
  geom_line()+
  labs(
    title = "Variance as Cluster Number Increases, Varying Sigma",
    x = "Number of Clusters (g)",
    y = "Variance") +
  theme_minimal() +
  theme(legend.position = "bottom")+
  facet_wrap(~factor(sigma, levels = c(0.05,1, 5, 10), labels = 
                       c("sigma=0.05", "sigma=1", "sigma=5", "sigma=10")))
sigma.plot1


alpha.plot1 <- ggplot(data = vary_alpha1, aes(x = g, y=variance)) +
  geom_line()+
  labs(
    title = "Variance as Cluster Number Increases, Varying Alpha",
    x = "Number of Clusters (g)",
    y = "Variance") +
  theme_minimal() +
  theme(legend.position = "bottom")+
  facet_wrap(~factor(alpha, levels = c(-5,-1,1,5), labels = 
                       c("alpha=-5", "alpha=-1", "alpha=1", "alpha=5")))
alpha.plot1


beta.plot1 <- ggplot(data = vary_beta1, aes(x = g, y=variance)) +
  geom_line()+
  labs(
    title = "Variance as Cluster Number Increases, Varying Beta",
    x = "Number of Clusters (g)",
    y = "Variance") +
  theme_minimal() +
  theme(legend.position = "bottom")+
  facet_wrap(~factor(beta, levels = c(-5,-1,1,5), labels = 
                       c("beta=-5", "beta=-1", "beta=1", "beta=5")))
beta.plot1

```

B=100k, c1=100, c2=50, c1/c2=2
```{r}

c2=50

g=seq(2,50,2)
r=calc_r(g, B, c1, c2)
r<-r[which(r>1)]
g<-g[1:length(r)]


vary_gamma2<-run_experiments(100, 1, 2, g,r, c(.05, 1, 5, 10), 1, "normal")
vary_sigma2<-run_experiments(100, 1, 2, g,r, 1,c(.05, 1, 5, 10), "normal")
vary_alpha2<-run_experiments(100, c(-5, -1, 1, 5), 2, g,r, 1,1, "normal")
vary_beta2<-run_experiments(100, 1, c(-5, -1, 1, 5), g,r, 1,1, "normal")



gamma.plot2 <- ggplot(data = vary_gamma2, aes(x = g, y=variance)) +
  geom_line()+
  labs(
    title = "Variance as Cluster Number Increases, Varying Gamma",
    x = "Number of Clusters (g)",
    y = "Variance") +
  theme_minimal() +
  theme(legend.position = "bottom")+
  facet_wrap(~factor(gamma, levels = c(0.05,1, 5, 10), labels = 
                       c("gamma=0.05", "gamma=1", "gamma=5", "gamma=10")))
gamma.plot2


sigma.plot2 <- ggplot(data = vary_sigma2, aes(x = g, y=variance)) +
  geom_line()+
  labs(
    title = "Variance as Cluster Number Increases, Varying Sigma",
    x = "Number of Clusters (g)",
    y = "Variance") +
  theme_minimal() +
  theme(legend.position = "bottom")+
  facet_wrap(~factor(sigma, levels = c(0.05,1, 5, 10), labels = 
                       c("sigma=0.05", "sigma=1", "sigma=5", "sigma=10")))
sigma.plot2


alpha.plot2 <- ggplot(data = vary_alpha2, aes(x = g, y=variance)) +
  geom_line()+
  labs(
    title = "Variance as Cluster Number Increases, Varying Alpha",
    x = "Number of Clusters (g)",
    y = "Variance") +
  theme_minimal() +
  theme(legend.position = "bottom")+
  facet_wrap(~factor(alpha, levels = c(-5,-1,1,5), labels = 
                       c("alpha=-5", "alpha=-1", "alpha=1", "alpha=5")))
alpha.plot2


beta.plot2 <- ggplot(data = vary_beta2, aes(x = g, y=variance)) +
  geom_line()+
  labs(
    title = "Variance as Cluster Number Increases, Varying Beta",
    x = "Number of Clusters (g)",
    y = "Variance") +
  theme_minimal() +
  theme(legend.position = "bottom")+
  facet_wrap(~factor(beta, levels = c(-5,-1,1,5), labels = 
                       c("beta=-5", "beta=-1", "beta=1", "beta=5")))
beta.plot2
```

B=100k, c1=100, c2=5, c1/c2=20
```{r}
c2=10

g=seq(2,50,2)
r=calc_r(g, B, c1, c2)
r<-r[which(r>1)]
g<-g[1:length(r)]

set.seed(2)
vary_gamma3<-run_experiments(100, 1, 2, g,r, c(.05, 1, 5, 10), 1, "normal")
vary_sigma3<-run_experiments(100, 1, 2, g,r, 1, c(.05, 1, 5, 10), "normal")
vary_alpha3<-run_experiments(100, c(-5, -1, 1, 5), 2, g,r, 1, 1, "normal")
vary_beta3<-run_experiments(100, 1, c(-5, -1, 1, 5), g,r, 1, 1, "normal")


gamma.plot3 <- ggplot(data = vary_gamma3, aes(x = g, y=variance)) +
  geom_line()+
  labs(
    title = "Variance as Cluster Number Increases, Varying Gamma",
    x = "Number of Clusters (g)",
    y = "Variance") +
  theme_minimal() +
  theme(legend.position = "bottom")+
  facet_wrap(~factor(gamma, levels = c(0.05,1, 5, 10), labels = 
                       c("gamma=0.05", "gamma=1", "gamma=5", "gamma=10")))
gamma.plot3


sigma.plot3 <- ggplot(data = vary_sigma3, aes(x = g, y=variance)) +
  geom_line()+
  labs(
    title = "Variance as Cluster Number Increases, Varying Sigma",
    x = "Number of Clusters (g)",
    y = "Variance") +
  theme_minimal() +
  theme(legend.position = "bottom")+
  facet_wrap(~factor(sigma, levels = c(0.05,1, 5, 10), labels = 
                       c("sigam=0.05", "sigma=1", "sigma=5", "sigma=10")))
sigma.plot3


alpha.plot3 <- ggplot(data = vary_alpha3, aes(x = g, y=variance)) +
  geom_line()+
  labs(
    title = "Variance as Cluster Number Increases, Varying Alpha",
    x = "Number of Clusters (g)",
    y = "Variance") +
  theme_minimal() +
  theme(legend.position = "bottom")+
  facet_wrap(~factor(alpha, levels = c(-5,-1,1,5), labels = 
                       c("alpha=-5", "alpha=-1", "alpha=1", "alpha=5")))
alpha.plot3


beta.plot3 <- ggplot(data = vary_beta3, aes(x = g, y=variance)) +
  geom_line()+
  labs(
    title = "Variance as Cluster Number Increases, Varying Beta",
    x = "Number of Clusters (g)",
    y = "Variance") +
  theme_minimal() +
  theme(legend.position = "bottom")+
  facet_wrap(~factor(beta, levels = c(-5,-1,1,5), labels = 
                       c("beta=-5", "beta=-1", "beta=1", "beta=5")))
beta.plot3

```

Poisson
```{r}

c2=95

g=seq(2,20,5)
r=calc_r(g, B, c1, c2)
r<-r[which(r>1)]
g<-g[1:length(r)]


## r and g must be at least 2??
set.seed(1)
vary_gamma4<-run_experiments(100, 1, 2, g,r, c(.05, 1, 5, 10), 1, "poisson")
vary_sigma4<-run_experiments(100, 1, 2, g,r, 1,1:4, "poisson")
vary_alpha4<-run_experiments(100, c(-5, -1, 1, 5), 2, g,r, 1, 1, "poisson")
vary_beta4<-run_experiments(100, 1, c(-5, -1, 1, 5), g,r, 1,1, "poisson")


gamma.plot4 <- ggplot(data = vary_gamma4, aes(x = g, y=variance)) +
  geom_line()+
  labs(
    title = "Variance as Cluster Number Increases, Varying Gamma",
    x = "Number of Clusters (g)",
    y = "Variance") +
  theme_minimal() +
  theme(legend.position = "bottom")+
  facet_wrap(~factor(gamma, levels = c(0.05,1, 5, 10), labels = 
                       c("gamma=0.05", "gamma=1", "gamma=5", "gamma=10")))
gamma.plot4


sigma.plot4 <- ggplot(data = vary_sigma4, aes(x = g, y=variance)) +
  geom_line()+
  labs(
    title = "Variance as Cluster Number Increases, Varying Sigma",
    x = "Number of Clusters (g)",
    y = "Variance") +
  theme_minimal() +
  theme(legend.position = "bottom")+
  facet_wrap(~factor(sigma, levels = c(1,2,3,4), labels = 
                       c("gamma=1", "gamma=2", "gamma=3", "gamma=4")))
sigma.plot4

alpha.plot4 <- ggplot(data = vary_alpha4, aes(x = g, y=variance)) +
  geom_line()+
  labs(
    title = "Variance as Cluster Number Increases, Varying Alpha",
    x = "Number of Clusters (g)",
    y = "Variance") +
  theme_minimal() +
  theme(legend.position = "bottom")+
  facet_wrap(~factor(alpha, levels = c(-5,-1,1,5), labels = 
                       c("alpha=-5", "alpha=-1", "alpha=1", "alpha=5")))
alpha.plot4

beta.plot4 <- ggplot(data = vary_beta4, aes(x = g, y=variance)) +
  geom_line()+
  labs(
    title = "Variance as Cluster Number Increases, Varying Beta",
    x = "Number of Clusters (g)",
    y = "Variance") +
  theme_minimal() +
  theme(legend.position = "bottom")+
  facet_wrap(~factor(beta, levels = c(-5,-1,1,5), labels = 
                       c("beta=-5", "beta=-1", "beta=1", "beta=5")))
beta.plot4


```


```{r}
c2=50

g=seq(2,20,5)
r=calc_r(g, B, c1, c2)
r<-r[which(r>1)]
g<-g[1:length(r)]


## r and g must be at least 2??
set.seed(1)
vary_gamma5<-run_experiments(100, 1, 2, g,r, c(.05, 1, 5, 10), 1, "poisson")
vary_sigma5<-run_experiments(100, 1, 2, g,r, 1,1:4, "poisson")
vary_beta5<-run_experiments(100, 1, c(-5, -1, 1, 5), g,r, 1,1, "poisson")


gamma.plot5 <- ggplot(data = vary_gamma5, aes(x = g, y=variance)) +
  geom_line()+
  labs(
    title = "Variance as Cluster Number Increases, Varying Gamma",
    x = "Number of Clusters (g)",
    y = "Variance") +
  theme_minimal() +
  theme(legend.position = "bottom")+
  facet_wrap(~factor(gamma, levels = c(0.05,1, 5, 10), labels = 
                       c("gamma=0.05", "gamma=1", "gamma=5", "gamma=10")))
gamma.plot5


sigma.plot5 <- ggplot(data = vary_sigma5, aes(x = g, y=variance)) +
  geom_line()+
  labs(
    title = "Variance as Cluster Number Increases, Varying Sigma",
    x = "Number of Clusters (g)",
    y = "Variance") +
  theme_minimal() +
  theme(legend.position = "bottom")+
  facet_wrap(~factor(sigma, levels = c(1,2,3,4), labels = 
                       c("gamma=1", "gamma=2", "gamma=3", "gamma=4")))
sigma.plot5



beta.plot5 <- ggplot(data = vary_beta5, aes(x = g, y=variance)) +
  geom_line()+
  labs(
    title = "Variance as Cluster Number Increases, Varying Beta",
    x = "Number of Clusters (g)",
    y = "Variance") +
  theme_minimal() +
  theme(legend.position = "bottom")+
  facet_wrap(~factor(beta, levels = c(-5,-1,1,5), labels = 
                       c("beta=-5", "beta=-1", "beta=1", "beta=5")))
beta.plot5



```


```{r}

c2=5

g=seq(2,20,5)
r=calc_r(g, B, c1, c2)
r<-r[which(r>1)]
g<-g[1:length(r)]


## r and g must be at least 2??
set.seed(1)
vary_gamma6<-run_experiments(100, 1, 2, g,r, c(.05, 1, 5, 10), 1, "poisson")
vary_sigma6<-run_experiments(100, 1, 2, g,r, 1,1:4, "poisson")
vary_beta6<-run_experiments(100, 1, c(-5, -1, 1, 5), g,r, 1,1, "poisson")


gamma.plot6 <- ggplot(data = vary_gamma6, aes(x = g, y=variance)) +
  geom_line()+
  labs(
    title = "Variance as Cluster Number Increases, Varying Gamma",
    x = "Number of Clusters (g)",
    y = "Variance") +
  theme_minimal() +
  theme(legend.position = "bottom")+
  facet_wrap(~factor(gamma, levels = c(0.05,1, 5, 10), labels = 
                       c("gamma=0.05", "gamma=1", "gamma=5", "gamma=10")))
gamma.plot6


sigma.plot6 <- ggplot(data = vary_sigma6, aes(x = g, y=variance)) +
  geom_line()+
  labs(
    title = "Variance as Cluster Number Increases, Varying Sigma",
    x = "Number of Clusters (g)",
    y = "Variance") +
  theme_minimal() +
  theme(legend.position = "bottom")+
  facet_wrap(~factor(sigma, levels = c(1,2,3,4), labels = 
                       c("gamma=1", "gamma=2", "gamma=3", "gamma=4")))
sigma.plot6



beta.plot6 <- ggplot(data = vary_beta6, aes(x = g, y=variance)) +
  geom_line()+
  labs(
    title = "Variance as Cluster Number Increases, Varying Beta",
    x = "Number of Clusters (g)",
    y = "Variance") +
  theme_minimal() +
  theme(legend.position = "bottom")+
  facet_wrap(~factor(beta, levels = c(-5,-1,1,5), labels = 
                       c("beta=-5", "beta=-1", "beta=1", "beta=5")))
beta.plot6

```


Qs

-What to do when model is singular (all Xs 1 or 0)->resample x or discard trial?
 
-Sometimes get Error Downdated VtV is not positive definite
  
-Ideal study design looks all the same with the normal distribution--what should we see?

-Is it enough to vary alpha, beta, gamma, sigma?

-

